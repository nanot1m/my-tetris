var X=Object.defineProperty;var N=(e,t,r)=>t in e?X(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var O=(e,t,r)=>(N(e,typeof t!="symbol"?t+"":t,r),r);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function r(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(n){if(n.ep)return;n.ep=!0;const s=r(n);fetch(n.href,s)}})();const C=class C{constructor(t){O(this,"seed");this.seed=t}next(){return this.seed=(C.A*this.seed+C.C)%C.MOD,this.seed/C.MOD}nextInt(t,r){return Math.floor(this.next()*(r-t+1))+t}};O(C,"A",1664525),O(C,"C",1013904223),O(C,"MOD",2**32);let k=C;var L=(e=>(e[e.I=0]="I",e[e.J=1]="J",e[e.L=2]="L",e[e.O=3]="O",e[e.S=4]="S",e[e.T=5]="T",e[e.Z=6]="Z",e))(L||{});const Y=[[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],[[1,0,0],[1,1,1],[0,0,0]],[[0,0,1],[1,1,1],[0,0,0]],[[1,1],[1,1]],[[0,1,1],[1,1,0],[0,0,0]],[[1,1,1],[0,1,0],[0,0,0]],[[1,1,0],[0,1,1],[0,0,0]]],I=e=>Y[e];function P(e){const t=e.length,r=new Array(t).fill(0).map(()=>new Array(t).fill(0));for(let o=0;o<t;o++)for(let n=0;n<t;n++)r[o][n]=e[t-n-1][o];return r}const R=[0,1,2,3,4,5];function*J(e){let t=[...R];for(;;){t.length===0&&(t=[...R]);const r=e.nextInt(0,t.length-1);yield t.splice(r,1)[0]}}const A=-1;function U(e,t){return Array.from({length:t},()=>Array.from({length:e},()=>A))}function M(e,t,r){for(let o=0;o<t.length;o++)for(let n=0;n<t[o].length;n++)if(t[o][n]!==0){const s=r.y+o,l=r.x+n;if(s>=e.length||l>=e[0].length)return!0;const i=e[s];if(i&&i[l]!==A)return!0}return!1}function Z(e,t,r,o){var s;let n=0;for(let l=0;l<r.length;l++){const i=o.y+l;for(let a=0;a<r[l].length;a++){const p=o.x+a;r[l][a]!==0&&(e[i][p]=t)}(s=e[i])!=null&&s.every(a=>a!==A)&&(e.splice(i,1),e.unshift(Array.from({length:e[0].length},()=>A)),n++)}return n}function q(e,t,r,o){const n={x:o.x,y:o.y+1};return M(e,r,n)?o.y===0?{type:"gameover"}:{type:"placed",burnedRows:Z(e,t,r,o)}:{type:"falling",nextPosition:n}}function G(e){if(e.nextTetrominoesCount<1)throw new Error("nextTetrominoesCount must be at least 1");if(e.speed<=0)throw new Error("speed must be greater than 0");if(e.width<4)throw new Error("width must be at least 4");if(e.height<4)throw new Error("height must be at least 4");for(let t=1;t<=4;t++)if(!e.scoring[t])throw new Error(`scoring must contain a value for ${t} burned rows`)}function K(e,t,r){G(e);const o=U(e.width,e.height),n=Math.floor(e.width/2);let s=0;const l=new k(e.seed),i=J(l);let a=i.next().value,p=[];for(let d=0;d<e.nextTetrominoesCount;d++)p.push(i.next().value);let f="playing",y={x:n,y:0},c=I(a),u=e.speed,g=0;const x=()=>f==="gameover",w=()=>({field:o,score:s,currentTetrominoe:a,tetrominoePosition:y,tetrominoeShape:c,nextTetrominoes:p,state:f,speed:u,totalBurnedRows:g}),m=d=>b=>{f==="playing"&&(d(b),r(w()))},h=[t.on("move",m(d=>{const b={...y};d.direction==="left"&&b.x--,d.direction==="right"&&b.x++,d.direction==="down"&&b.y++,M(o,c,b)||(y=b)})),t.on("rotate",m(()=>{const d=P(c);M(o,d,y)||(c=d)})),t.on("drop",m(()=>{for(;!M(o,c,{...y,y:y.y+1});)y.y++})),t.on("pause",m(()=>{f=f==="paused"?"playing":"paused"}))];function v(){if(f!=="playing")return;const d=q(o,a,c,y);if(d.type==="gameover"){f="gameover",h.forEach(b=>b.unsubscribe());return}d.type==="placed"&&(g+=d.burnedRows,s+=e.scoring[d.burnedRows],a=p.shift(),p.push(i.next().value),y={x:n,y:0},c=I(a)),d.type==="falling"&&(y=d.nextPosition),r(w())}function E(){v(),x()||setTimeout(E,2e3/u)}return{start(){E()},stop(){f="gameover",v()}}}const D={[A]:"#000000",[L.I]:"#00FFFF",[L.J]:"#0000FF",[L.L]:"#FFA500",[L.O]:"#FFFF00",[L.S]:"#00FF00",[L.T]:"#800080",[L.Z]:"#FF0000"},F=20;function W(e,t){const r=document.createElement("canvas");r.width=t.width*F,r.height=t.height*F;const o=document.createElement("div");o.style.fontSize="24px",o.style.fontWeight="bold",o.style.fontFamily="monospace",o.style.textAlign="right",o.style.gridArea="score";const n=document.createElement("canvas");n.width=4*F,n.height=t.nextTetrominoesCount*4*F,e.appendChild(o),e.appendChild(r),e.appendChild(n);function s(c,u,g,x){x.fillStyle=g,x.fillRect(c*F+1,u*F+1,F-1,F-1)}function l(c){o.textContent=`${c.score}`}function i(c,u,g,x){for(let w=0;w<c.length;w++){const m=g.y+w;for(let h=0;h<c[w].length;h++){const v=g.x+h;if(c[w][h]){const E=D[u];s(v,m,E,x)}}}}function a(c,u){u.clearRect(0,0,u.canvas.width,u.canvas.height);const{field:g,tetrominoePosition:x,tetrominoeShape:w,currentTetrominoe:m}=c;for(let h=0;h<g.length;h++)for(let v=0;v<g[h].length;v++){const E=D[g[h][v]];s(v,h,E,u)}i(w,m,x,u)}function p(c,u){u.clearRect(0,0,u.canvas.width,u.canvas.height);const{nextTetrominoes:g}=c;g.forEach((x,w)=>{for(let h=0;h<4;h++)for(let v=0;v<4;v++){const E=D[A];s(v,h+w*4,E,u)}const m=I(x);i(m,x,{x:0,y:w*4},u)})}const f=r.getContext("2d");if(!f)throw new Error("Canvas 2d context not supported");const y=n.getContext("2d");if(!y)throw new Error("Canvas 2d context not supported");return{onNextLevelState:c=>{l(c),a(c,f),p(c,y)}}}function $(){const e=new Map;return{on(t,r){const o=e.get(t)??new Set;return o.add(r),e.set(t,o),{unsubscribe(){o.delete(r)}}},dispatch(t){const r=e.get(t.type);if(r)for(const o of r)o(t)}}}function j(e,t){const r=$(),o=i=>{switch(i.key){case"ArrowLeft":{i.preventDefault(),r.dispatch({type:"move",direction:"left"});break}case"ArrowRight":{i.preventDefault(),r.dispatch({type:"move",direction:"right"});break}case"ArrowDown":{i.preventDefault(),r.dispatch({type:"move",direction:"down"});break}case"ArrowUp":{i.preventDefault(),r.dispatch({type:"rotate",direction:"clockwise"});break}case" ":{i.preventDefault(),r.dispatch({type:"drop"});break}case"Escape":case"Enter":{i.preventDefault(),r.dispatch({type:"pause"});break}}};let n={x:0,y:0};function s(i){n.x=i.touches[0].clientX,n.y=i.touches[0].clientY}function l(i){const a=i.touches[0],p=a.clientX-n.x,f=a.clientY-n.y;if(console.log({dx:p,dy:f}),Math.abs(p)>Math.abs(f)){if(Math.abs(p)<t)return;p<0?r.dispatch({type:"move",direction:"left"}):r.dispatch({type:"move",direction:"right"})}else if(f>t)r.dispatch({type:"move",direction:"down"});else if(f<-t*2)r.dispatch({type:"rotate",direction:"clockwise"});else return;n.x=a.clientX,n.y=a.clientY}return e.addEventListener("keydown",o),e.addEventListener("touchstart",s),e.addEventListener("touchmove",l),{bus:r,destroy(){e.removeEventListener("keydown",o),e.removeEventListener("touchstart",s),e.removeEventListener("touchmove",l)}}}const z=document.querySelector("#app"),S={width:10,height:20,nextTetrominoesCount:3,scoring:{0:0,1:40,2:100,3:300,4:1200},seed:Date.now(),speed:2},H=j(document.body,20),B=W(z,S),Q=K(S,H.bus,e=>B.onNextLevelState(e));Q.start();
