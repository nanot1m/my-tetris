var P=Object.defineProperty;var Y=(e,t,n)=>t in e?P(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var A=(e,t,n)=>(Y(e,typeof t!="symbol"?t+"":t,n),n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const h of s.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&r(h)}).observe(document,{childList:!0,subtree:!0});function n(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(o){if(o.ep)return;o.ep=!0;const s=n(o);fetch(o.href,s)}})();const E=class E{constructor(t){A(this,"seed");this.seed=t}next(){return this.seed=(E.A*this.seed+E.C)%E.MOD,this.seed/E.MOD}nextInt(t,n){return Math.floor(this.next()*(n-t+1))+t}};A(E,"A",1664525),A(E,"C",1013904223),A(E,"MOD",2**32);let S=E;var F=(e=>(e[e.I=0]="I",e[e.J=1]="J",e[e.L=2]="L",e[e.O=3]="O",e[e.S=4]="S",e[e.T=5]="T",e[e.Z=6]="Z",e))(F||{});const $=[[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],[[1,0,0],[1,1,1],[0,0,0]],[[0,0,1],[1,1,1],[0,0,0]],[[1,1],[1,1]],[[0,1,1],[1,1,0],[0,0,0]],[[1,1,1],[0,1,0],[0,0,0]],[[1,1,0],[0,1,1],[0,0,0]]],D=e=>$[e];function J(e){const t=e.length,n=new Array(t).fill(0).map(()=>new Array(t).fill(0));for(let r=0;r<t;r++)for(let o=0;o<t;o++)n[r][o]=e[t-o-1][r];return n}const I=[0,1,2,3,4,5];function*U(e){let t=[...I];for(;;){t.length===0&&(t=[...I]);const n=e.nextInt(0,t.length-1);yield t.splice(n,1)[0]}}const L=-1;function W(e,t){return Array.from({length:t},()=>Array.from({length:e},()=>L))}function k(e,t,n){for(let r=0;r<t.length;r++)for(let o=0;o<t[r].length;o++)if(t[r][o]!==0){const s=n.y+r,h=n.x+o;if(s>=e.length||h>=e[0].length)return!0;const l=e[s];if(l&&l[h]!==L)return!0}return!1}function Z(e,t,n,r){var s;let o=0;for(let h=0;h<n.length;h++){const l=r.y+h;for(let f=0;f<n[h].length;f++){const m=r.x+f;n[h][f]!==0&&(e[l][m]=t)}(s=e[l])!=null&&s.every(f=>f!==L)&&(e.splice(l,1),e.unshift(Array.from({length:e[0].length},()=>L)),o++)}return o}function q(e,t,n,r){const o={x:r.x,y:r.y+1};return k(e,n,o)?r.y===0?{type:"gameover"}:{type:"placed",burnedRows:Z(e,t,n,r)}:{type:"falling",nextPosition:o}}function G(e){if(e.nextTetrominoesCount<1)throw new Error("nextTetrominoesCount must be at least 1");if(e.speed<=0)throw new Error("speed must be greater than 0");if(e.width<4)throw new Error("width must be at least 4");if(e.height<4)throw new Error("height must be at least 4");for(let t=1;t<=4;t++)if(!e.scoring[t])throw new Error(`scoring must contain a value for ${t} burned rows`)}function H(e,t,n){G(e);const r=W(e.width,e.height),o=Math.floor(e.width/2);let s=0;const h=new S(e.seed),l=U(h);let f=l.next().value,m=[];for(let c=0;c<e.nextTetrominoesCount;c++)m.push(l.next().value);let g="playing",b=D(f),v={x:o-Math.floor(b.length/2),y:0},d=e.speed,a=0;const y=()=>g==="gameover",i=()=>({field:r,score:s,currentTetrominoe:f,tetrominoePosition:v,tetrominoeShape:b,nextTetrominoes:m,state:g,speed:d,totalBurnedRows:a}),u=c=>x=>{g==="playing"&&(c(x),n(i()))},C=[t.on("move",u(c=>{const x={...v};c.direction==="left"&&x.x--,c.direction==="right"&&x.x++,c.direction==="down"&&x.y++,k(r,b,x)||(v=x)})),t.on("rotate",u(()=>{const c=J(b);k(r,c,v)||(b=c)})),t.on("drop",u(()=>{for(;!k(r,b,{...v,y:v.y+1});)v.y++})),t.on("pause",u(()=>{g=g==="paused"?"playing":"paused"}))];function w(){if(g!=="playing")return;const c=q(r,f,b,v);if(c.type==="gameover"){g="gameover",C.forEach(x=>x.unsubscribe());return}c.type==="placed"&&(a+=c.burnedRows,s+=e.scoring[c.burnedRows],f=m.shift(),m.push(l.next().value),b=D(f),v={x:o-Math.floor(b[0].length/2),y:0}),c.type==="falling"&&(v=c.nextPosition),n(i())}function p(){w(),y()||setTimeout(p,2e3/d)}return{start(){p()},stop(){g="gameover",w()}}}const O={[L]:"#2a2a2a",[F.I]:"#00FFFF",[F.J]:"#0000FF",[F.L]:"#FFA500",[F.O]:"#FFFF00",[F.S]:"#00FF00",[F.T]:"#800080",[F.Z]:"#FF0000"},M=20,R=15;function X(e){const t=window.devicePixelRatio||1,n=e.canvas.width,r=e.canvas.height;e.canvas.width=n*t,e.canvas.height=r*t,e.canvas.style.width=`${n}px`,e.canvas.style.height=`${r}px`,e.scale(t,t)}function K(e,t){const n=document.createElement("canvas");n.width=t.width*M,n.height=t.height*M;const r=document.createElement("div");r.style.fontSize="24px",r.style.fontWeight="bold",r.style.fontFamily="monospace",r.style.textAlign="right",r.style.gridArea="score";const o=document.createElement("canvas");o.width=4*R,o.height=t.nextTetrominoesCount*4*R,e.appendChild(r),e.appendChild(n),e.appendChild(o);function s(d,a,y,i,u){u.fillStyle=y,u.fillRect(d*i,a*i,i,i)}function h(d,a,y,i,u){s(d,a,O[L],i,u),u.strokeStyle=y,u.strokeRect(d*i+1,a*i+1,i-1,i-1),u.strokeRect(d*i+3,a*i+3,i-6,i-6),u.fillStyle=y,u.fillRect(d*i+5,a*i+5,i-8,i-8)}function l(d){r.textContent=`${d.score}`}function f(d,a,y,i,u){for(let C=0;C<d.length;C++){const w=y.y+C;for(let p=0;p<d[C].length;p++){const c=y.x+p;if(d[C][p]){const x=O[a];h(c,w,x,i,u)}}}}function m(d,a){a.clearRect(0,0,a.canvas.width,a.canvas.height);const{field:y,tetrominoePosition:i,tetrominoeShape:u,currentTetrominoe:C}=d;for(let w=0;w<y.length;w++)for(let p=0;p<y[w].length;p++){const c=O[y[w][p]];y[w][p]!==L?h(p,w,c,M,a):s(p,w,c,M,a)}f(u,C,i,M,a)}function g(d,a){a.clearRect(0,0,a.canvas.width,a.canvas.height);const{nextTetrominoes:y}=d;y.forEach((i,u)=>{for(let p=0;p<4;p++)for(let c=0;c<4;c++){const x=O[L];s(c,p+u*4,x,R,a)}const C=D(i),w=(4-C.length)/2;f(C,i,{x:w,y:u*4+w},R,a)})}const b=n.getContext("2d");if(!b)throw new Error("Canvas 2d context not supported");X(b);const v=o.getContext("2d");if(!v)throw new Error("Canvas 2d context not supported");return X(v),{onNextLevelState:d=>{l(d),m(d,b),g(d,v)}}}function j(){const e=new Map;return{on(t,n){const r=e.get(t)??new Set;return r.add(n),e.set(t,r),{unsubscribe(){r.delete(n)}}},dispatch(t){const n=e.get(t.type);if(n)for(const r of n)r(t)}}}function B(e,t){const n=j(),r=l=>{switch(l.key){case"ArrowLeft":{l.preventDefault(),n.dispatch({type:"move",direction:"left"});break}case"ArrowRight":{l.preventDefault(),n.dispatch({type:"move",direction:"right"});break}case"ArrowDown":{l.preventDefault(),n.dispatch({type:"move",direction:"down"});break}case"ArrowUp":{l.preventDefault(),n.dispatch({type:"rotate",direction:"clockwise"});break}case" ":{l.preventDefault(),n.dispatch({type:"drop"});break}case"Escape":case"Enter":{l.preventDefault(),n.dispatch({type:"pause"});break}}};let o={x:0,y:0};function s(l){o.x=l.touches[0].clientX,o.y=l.touches[0].clientY}function h(l){const f=l.touches[0],m=f.clientX-o.x,g=f.clientY-o.y;if(console.log({dx:m,dy:g}),Math.abs(m)>Math.abs(g)){if(Math.abs(m)<t)return;m<0?n.dispatch({type:"move",direction:"left"}):n.dispatch({type:"move",direction:"right"})}else if(g>t)n.dispatch({type:"move",direction:"down"});else if(g<-t*2)n.dispatch({type:"rotate",direction:"clockwise"});else return;o.x=f.clientX,o.y=f.clientY}return e.addEventListener("keydown",r),e.addEventListener("touchstart",s),e.addEventListener("touchmove",h),{bus:n,destroy(){e.removeEventListener("keydown",r),e.removeEventListener("touchstart",s),e.removeEventListener("touchmove",h)}}}const Q=document.querySelector("#app"),N={width:10,height:20,nextTetrominoesCount:3,scoring:{0:0,1:40,2:100,3:300,4:1200},seed:Date.now(),speed:2},T=B(document.body,20),V=K(Q,N),_=H(N,T.bus,e=>V.onNextLevelState(e));_.start();
