var X=Object.defineProperty;var N=(e,t,o)=>t in e?X(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var O=(e,t,o)=>(N(e,typeof t!="symbol"?t+"":t,o),o);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function o(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(n){if(n.ep)return;n.ep=!0;const i=o(n);fetch(n.href,i)}})();const C=class C{constructor(t){O(this,"seed");this.seed=t}next(){return this.seed=(C.A*this.seed+C.C)%C.MOD,this.seed/C.MOD}nextInt(t,o){return Math.floor(this.next()*(o-t+1))+t}};O(C,"A",1664525),O(C,"C",1013904223),O(C,"MOD",2**32);let S=C;var L=(e=>(e[e.I=0]="I",e[e.J=1]="J",e[e.L=2]="L",e[e.O=3]="O",e[e.S=4]="S",e[e.T=5]="T",e[e.Z=6]="Z",e))(L||{});const Y=[[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],[[1,0,0],[1,1,1],[0,0,0]],[[0,0,1],[1,1,1],[0,0,0]],[[1,1],[1,1]],[[0,1,1],[1,1,0],[0,0,0]],[[1,1,1],[0,1,0],[0,0,0]],[[1,1,0],[0,1,1],[0,0,0]]],k=e=>Y[e];function P(e){const t=e.length,o=new Array(t).fill(0).map(()=>new Array(t).fill(0));for(let r=0;r<t;r++)for(let n=0;n<t;n++)o[r][n]=e[t-n-1][r];return o}const I=[0,1,2,3,4,5];function*z(e){let t=[...I];for(;;){t.length===0&&(t=[...I]);const o=e.nextInt(0,t.length-1);yield t.splice(o,1)[0]}}const A=-1;function J(e,t){return Array.from({length:t},()=>Array.from({length:e},()=>A))}function M(e,t,o){for(let r=0;r<t.length;r++)for(let n=0;n<t[r].length;n++)if(t[r][n]!==0){const i=o.y+r,s=o.x+n;if(i>=e.length||s>=e[0].length)return!0;const a=e[i];if(a&&a[s]!==A)return!0}return!1}function K(e,t,o,r){var i;let n=0;for(let s=0;s<o.length;s++){const a=r.y+s;for(let l=0;l<o[s].length;l++){const w=r.x+l;o[s][l]!==0&&(e[a][w]=t)}(i=e[a])!=null&&i.every(l=>l!==A)&&(e.splice(a,1),e.unshift(Array.from({length:e[0].length},()=>A)),n++)}return n}function U(e,t,o,r){const n={x:r.x,y:r.y+1};return M(e,o,n)?r.y===0?{type:"gameover"}:{type:"placed",burnedRows:K(e,t,o,r)}:{type:"falling",nextPosition:n}}function Z(e){if(e.nextTetrominoesCount<1)throw new Error("nextTetrominoesCount must be at least 1");if(e.speed<=0)throw new Error("speed must be greater than 0");if(e.width<4)throw new Error("width must be at least 4");if(e.height<4)throw new Error("height must be at least 4");for(let t=1;t<=4;t++)if(!e.scoring[t])throw new Error(`scoring must contain a value for ${t} burned rows`)}function q(e,t,o){Z(e);const r=J(e.width,e.height),n=Math.floor(e.width/2);let i=0;const s=new S(e.seed),a=z(s);let l=a.next().value,w=[];for(let d=0;d<e.nextTetrominoesCount;d++)w.push(a.next().value);let v="playing",h={x:n,y:0},c=k(l),u=e.speed,p=0;const x=()=>v==="gameover",y=()=>({field:r,score:i,currentTetrominoe:l,tetrominoePosition:h,tetrominoeShape:c,nextTetrominoes:w,state:v,speed:u,totalBurnedRows:p}),m=d=>b=>{v==="playing"&&(d(b),o(y()))},f=[t.on("move",m(d=>{const b={...h};d.direction==="left"&&b.x--,d.direction==="right"&&b.x++,d.direction==="down"&&b.y++,M(r,c,b)||(h=b)})),t.on("rotate",m(()=>{const d=P(c);M(r,d,h)||(c=d)})),t.on("drop",m(()=>{for(;!M(r,c,{...h,y:h.y+1});)h.y++})),t.on("pause",m(()=>{v=v==="paused"?"playing":"paused"}))];function g(){if(v!=="playing")return;const d=U(r,l,c,h);if(d.type==="gameover"){v="gameover",f.forEach(b=>b.unsubscribe());return}d.type==="placed"&&(p+=d.burnedRows,i+=e.scoring[d.burnedRows],l=w.shift(),w.push(a.next().value),h={x:n,y:0},c=k(l)),d.type==="falling"&&(h=d.nextPosition),o(y())}function E(){g(),x()||setTimeout(E,2e3/u)}return{start(){E()},stop(){v="gameover",g()}}}const D={[A]:"#000000",[L.I]:"#00FFFF",[L.J]:"#0000FF",[L.L]:"#FFA500",[L.O]:"#FFFF00",[L.S]:"#00FF00",[L.T]:"#800080",[L.Z]:"#FF0000"},F=20;function G(e,t){const o=document.createElement("canvas");o.width=t.width*F,o.height=t.height*F;const r=document.createElement("div");r.style.fontSize="24px",r.style.fontWeight="bold",r.style.fontFamily="monospace",r.style.width="80px",r.style.textAlign="right";const n=document.createElement("canvas");n.width=4*F,n.height=t.nextTetrominoesCount*4*F,e.appendChild(r),e.appendChild(o),e.appendChild(n);function i(c,u,p,x){x.fillStyle=p,x.fillRect(c*F+1,u*F+1,F-1,F-1)}function s(c){r.textContent=`${c.score}`}function a(c,u,p,x){for(let y=0;y<c.length;y++){const m=p.y+y;for(let f=0;f<c[y].length;f++){const g=p.x+f;if(c[y][f]){const E=D[u];i(g,m,E,x)}}}}function l(c,u){u.clearRect(0,0,u.canvas.width,u.canvas.height);const{field:p,tetrominoePosition:x,tetrominoeShape:y,currentTetrominoe:m}=c;for(let f=0;f<p.length;f++)for(let g=0;g<p[f].length;g++){const E=D[p[f][g]];i(g,f,E,u)}a(y,m,x,u)}function w(c,u){u.clearRect(0,0,u.canvas.width,u.canvas.height);const{nextTetrominoes:p}=c;p.forEach((x,y)=>{for(let f=0;f<4;f++)for(let g=0;g<4;g++){const E=D[A];i(g,f+y*4,E,u)}const m=k(x);a(m,x,{x:0,y:y*4},u)})}const v=o.getContext("2d");if(!v)throw new Error("Canvas 2d context not supported");const h=n.getContext("2d");if(!h)throw new Error("Canvas 2d context not supported");return{onNextLevelState:c=>{s(c),l(c,v),w(c,h)}}}function W(){const e=new Map;return{on(t,o){const r=e.get(t)??new Set;return r.add(o),e.set(t,r),{unsubscribe(){r.delete(o)}}},dispatch(t){const o=e.get(t.type);if(o)for(const r of o)r(t)}}}function $(e){const t=W(),o=s=>{switch(s.key){case"ArrowLeft":{s.preventDefault(),t.dispatch({type:"move",direction:"left"});break}case"ArrowRight":{s.preventDefault(),t.dispatch({type:"move",direction:"right"});break}case"ArrowDown":{s.preventDefault(),t.dispatch({type:"move",direction:"down"});break}case"ArrowUp":{s.preventDefault(),t.dispatch({type:"rotate",direction:"clockwise"});break}case" ":{s.preventDefault(),t.dispatch({type:"drop"});break}case"Escape":case"Enter":{s.preventDefault(),t.dispatch({type:"pause"});break}}};let r={x:0,y:0};function n(s){r.x=s.touches[0].clientX,r.y=s.touches[0].clientY}function i(s){const a=s.touches[0],l=a.clientX-r.x,w=a.clientY-r.y;if(console.log({dx:l,dy:w}),Math.abs(l)>Math.abs(w)){if(Math.abs(l)<20)return;l<0?t.dispatch({type:"move",direction:"left"}):t.dispatch({type:"move",direction:"right"})}else{if(w>-20*2)return;t.dispatch({type:"rotate",direction:"clockwise"})}r.x=a.clientX,r.y=a.clientY}return e.addEventListener("keydown",o),e.addEventListener("touchstart",n),e.addEventListener("touchmove",i),{bus:t,destroy(){e.removeEventListener("keydown",o),e.removeEventListener("touchstart",n),e.removeEventListener("touchmove",i)}}}const j=document.querySelector("#app"),R={width:10,height:20,nextTetrominoesCount:3,scoring:{0:0,1:40,2:100,3:300,4:1200},seed:Date.now(),speed:2},H=$(document.body),B=G(j,R),Q=q(R,H.bus,e=>B.onNextLevelState(e));Q.start();
